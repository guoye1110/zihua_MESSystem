using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using LabelPrint.Util;
using LabelPrint.Data;
using LabelPrint.Receipt;
using LabelPrint.PrintForms;
namespace LabelPrint
{


    public partial class RecoveryForm : Form
    {
        RcvInputData UserInput;
        public RecoveryForm()
        {
            InitializeComponent();
        }

        private void tb_PlatelPerLayx_KeyPress(object sender, KeyPressEventArgs e)
        {
            ControlHelper.LimitToDigitOnly(e);
        }

        private void button1_Click(object sender, EventArgs e)
        {
            //update the data from UI or Scale.
            UpdateProductData();
            if (UserInput.WorkNo==null)
            {
                MessageBox.Show("打印标签之前必须先扫描！");
                return;
            }
            UserInput.UpdateDateTime();
            tb_DateTime.Text = UserInput.GetDateTime();
            //Printing
            PrintLabel();
            //save the data to local database
            CreateLocalDataBaseItem();
            //Save the data to server
            SendItemToServer();
            PostUpdateProductData();
        }
        private void UpdateUserInput()
        {

            UserInput.WorkProcess = //tb_WorkProcess.Text;
            UserInput.Recipe = tb_RecipeNo.Text;
            UserInput.Color = tb_Color.Text;
            //UserInput.Vendor = tb_Vendor.Text;
            UserInput.WeightPerBag = tb_WeightPerBag.Text;
            //UserInput.StackWeight = tb_StackWeight.Text;
            //UserInput.Bags_x = tb_PlatelPerLayx.Text;
            //UserInput.Bags_y = tb_PlatelPerLayy.Text;
            //UserInput.Bags_xy = tb_PlateRollNum.Text;

            UserInput.WorkerNo = tb_WorkerNo.Text;

            UserInput.Desc = tb_Desc.Text;
            UserInput.OldCode1 = tb_OldCode1.Text;
            UserInput.OldCode2 = tb_OldCode2.Text;
            UserInput.OldCode3 = tb_OldCode3.Text;
            UserInput.OldCode4 = tb_OldCode4.Text;
            UserInput.OldCode5 = tb_OldCode5.Text;
            UserInput.OldCode6 = tb_OldCode6.Text;
            UserInput.OldCode7 = tb_OldCode7.Text;
            UserInput.OldCode8 = tb_OldCode8.Text;
            UserInput.OldCode9 = tb_OldCode9.Text;
            UserInput.OldCode10 = tb_OldCode10.Text;

        }
        private void UpdateProductData()
        {
             UpdateUserInput();
        }

        private void PrintLabel()
        {
            //SystemSetting SysSetting;
            //SysSetting = GlobalConfig.Setting;

            //SysSetting.DynPrintData = new DynamicPrintLabelData();
            //DynamicPrintLabelData DynPrintData = SysSetting.DynPrintData;
            //UserInput.UpdatePrintPrintData(DynPrintData);
            ////RecoveryLabel label = new RecoveryLabel();
            ////label.Printlabel();
            UserInput.PrintLabel();
        }
        private void CreateLocalDataBaseItem()
        {
            UserInput.insertOneRow();
        }
        private void SendItemToServer()
        {

        }
        private void PostUpdateProductData()
        {
            lb_OutputBarcode.Text = UserInput.OutputBarcode;
            //tb_DateTime.Text = DateTime.Now.ToString("yyyy-MM-dd HH-mm-ss");
        }

        private void RecoveryForm_Load(object sender, EventArgs e)
        {
            UserInput = new RcvInputData();
            UserInput.CreateDataTable();
            //tb_WorkProcess.Text = "再造料工序";
            //tb_WorkProcess.Enabled = false;
            tb_DateTime.Enabled = false;
            tb_WorkerNo.Text = gVariable.userAccount;
            tb_WorkerNo.Enabled = false;
            lb_InputBarcode.Text = "";
            lb_OutputBarcode.Text = "";
        }
        static int v = 0;
        private void bt_Scan_Click(object sender, EventArgs e)
        {
            String barcode;
            String orderNo;
            String batchNo;
            String DevNo;
            String WorkNoSn;
            String productName;

            ScanForm f = new ScanForm();
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                barcode = f.GetBarCodeValue();
            
                if (v==0 )
                {
                    v = 1;
                    barcode = "S17110906L302S118012014310500100";
                }
                else
                {
                    v = 0;
                    barcode = "S17110906L302P21801201431050";
                }
                if (!UserInput.ParseBarCode(barcode))
                    return;

                //tb_WorkNo.Text = UserInput.WorkNo;
                if (!UserInput.ParseWorkNo(UserInput.WorkNo,  out batchNo, out DevNo, out WorkNoSn))
                    return;
                if (gVariable.orderNo != null)
                {
                    orderNo = gVariable.orderNo;
                    if (!UserInput.GetProductInfoBySaleOrder(orderNo, out UserInput.ProductCode, out productName, out UserInput.CustomerName))
                        return;
                    if (!UserInput.GetRecoveryInfoByProductCode(UserInput.ProductCode, out UserInput.WeightPerBag, out UserInput.RecipeCode, out UserInput.Color))
                        return;
                }
                UserInput.InputBarcode = barcode;
                lb_InputBarcode.Text = barcode;
                tb_Color.Text = UserInput.Color;
                tb_WeightPerBag.Text = UserInput.WeightPerBag;
                tb_RecipeNo.Text = UserInput.RecipeCode;
                
            }
        }

        private void bt_Record_Click(object sender, EventArgs e)
        {
#if true
            String barcode;
            UpdateScanForm f = new UpdateScanForm();
            f.SetUserInput(UserInput);
            f.ShowDialog();
#else
            String barcode;

            ScanForm f = new ScanForm();
            f.ShowDialog();
            if (f.DialogResult == DialogResult.OK)
            {
                barcode = f.GetBarCodeValue();

                barcode = UserInput.OutputBarcode;
                if (!UserInput.UpdateMStateInDB(barcode))
                    return;
#endif          
        }
    }
    }
